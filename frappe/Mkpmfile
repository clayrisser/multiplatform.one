include $(MKPM)/mkpm
include $(MKPM)/chain
include $(MKPM)/dotenv

FRAPPE_BRANCH ?= version-15-hotfix

.PHONY: install
install: frappe-bench/Procfile
	@for p in /workspace/development/frappe/*; do \
		if [ -d "$$p" ] && [ "$$(basename "$$p")" != "frappe-bench" ]; then \
			_NAME="$$(basename "$$p")"; \
			if [ ! -L "/workspace/development/frappe/frappe-bench/apps/$$_NAME" ]; then \
				ln -s "$$p" "/workspace/development/frappe/frappe-bench/apps/$$_NAME"; \
			fi; \
			frappe-bench/env/bin/python -m pip install --upgrade -e "/workspace/development/frappe/frappe-bench/apps/$$_NAME"; \
			(echo "$$_NAME" && cat "/workspace/development/frappe/frappe-bench/sites/apps.txt") | sort | uniq > "/workspace/development/frappe/frappe-bench/sites/_apps.txt"; \
			mv "/workspace/development/frappe/frappe-bench/sites/_apps.txt" "/workspace/development/frappe/frappe-bench/sites/apps.txt"; \
			(cd "/workspace/development/frappe/frappe-bench" && bench build --app "$$_NAME"); \
			(cd "/workspace/development/frappe/frappe-bench" && bench --site localhost install-app "$$_NAME"); \
		fi; \
	done
frappe-bench/Procfile:
	@frappe-installer --apps-json apps.json --site-name localhost --frappe-branch $(FRAPPE_BRANCH)

.PHONY: uninstall
uninstall:
	@rm -rf frappe-bench
	@echo "SELECT CONCAT('DROP DATABASE \`', SCHEMA_NAME, '\`;') FROM INFORMATION_SCHEMA.SCHEMATA WHERE SCHEMA_NAME LIKE '\\_%';" | \
		mysql -hmariadb -uroot -p123 -N | mysql -hmariadb -uroot -p123

.PHONY: reinstall
reinstall: uninstall install

.PHONY: dev
dev:
	@cd frappe/frappe-bench; \
		. frappe/frappe-bench/env/bin/activate; \
		honcho start web socketio watch schedule worker
